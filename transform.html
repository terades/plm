<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Produktionsauftrag Transformation</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Stellt sicher, dass der JSON-Inhalt korrekt umgebrochen wird */
  pre {
    margin: 0;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .collapsed {
    max-height: 9em;
    overflow: hidden;
  }
  /* Farben für die Syntaxhervorhebung des JSON */
  pre.syntax-highlight .key { color: #0451a5; }
  pre.syntax-highlight .string { color: #a31515; }
  pre.syntax-highlight .number { color: #098658; }
  pre.syntax-highlight .boolean { color: #0000ff; }
  pre.syntax-highlight .null { color: #008080; }
</style>
</head>
<body class="p-6 font-sans bg-gray-50 text-gray-800">

<div class="max-w-7xl mx-auto">
  <h1 class="text-3xl font-bold mb-2">CSV zu JSON Transformation</h1>
  <p class="mb-6 text-gray-600">Fügen Sie unten die CSV-Zeilen ein oder laden Sie eine CSV-Datei hoch. Jeder Datensatz wird automatisch anhand der hinterlegten JSONata-Regel transformiert.</p>

  <input type="file" id="csvFile" accept=".csv" class="mb-4" />

  <textarea id="csvInput" rows="12" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="CSV-Daten hier einfügen..."></textarea>
  <button id="transformButton" class="w-full sm:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 mb-8">Transformieren</button>

  <h2 class="text-2xl font-bold mb-4">Ausgabe</h2>
  <div id="filterBar" class="grid grid-cols-5 gap-4 mb-4">
    <div id="filterProductionId" class="filter-group p-2 border rounded">
      <input type="text" class="filter-search p-1 border rounded w-full mb-1" placeholder="productionId" />
      <div class="filter-options flex flex-wrap gap-1"></div>
    </div>
    <div id="filterProject" class="filter-group p-2 border rounded">
      <input type="text" class="filter-search p-1 border rounded w-full mb-1" placeholder="project" />
      <div class="filter-options flex flex-wrap gap-1"></div>
    </div>
    <div id="filterItemNumber" class="filter-group p-2 border rounded">
      <input type="text" class="filter-search p-1 border rounded w-full mb-1" placeholder="itemNumber" />
      <div class="filter-options flex flex-wrap gap-1"></div>
    </div>
    <div id="filterResource" class="filter-group p-2 border rounded">
      <input type="text" class="filter-search p-1 border rounded w-full mb-1" placeholder="resource" />
      <div class="filter-options flex flex-wrap gap-1"></div>
    </div>
    <input id="filterFreeText" type="text" placeholder="Freitext" class="p-2 border rounded" />
  </div>
  <div class="overflow-hidden border border-gray-200 rounded-lg shadow-md">
    <table id="resultsTable" class="w-full table-auto border-collapse">
      <thead class="bg-gray-100">
        <tr class="text-left">
          <th class="border-b p-3 font-semibold w-16">#</th>
          <th class="border-b p-3 font-semibold">Transformiertes JSON</th>
          <th class="border-b p-3 font-semibold w-32 text-center">Aktion</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsonata@1.8.6/jsonata.min.js"></script>
<script>
// Die JSONata-Expression wird hier korrigiert.
const expression = `{
  "messageType": [
    "GB.D365EventProcessor.D365EventTransformed.ProductionOrderReleased"
  ],
  "timestamp": $join([FXLHeader.SystemDate, "T", FXLHeader.SystemTime, ".000Z"]),
  "productionId": ProdTable.FIELD_ProdTable_ProdId,
  "project": ProdTable.SalesTable.FIELD_SalesTable_GLDGlobalProjId ? ProdTable.SalesTable.FIELD_SalesTable_GLDGlobalProjId : null,
  "productionStatus": ProdTable.FIELD_ProdTable_ProdStatus,
  "productionSite": FXLHeader.Company,
  "productionWarehouse": ProdTable.FIELD_ProdTable_inventDim_InventLocationId,
  "plannedProductionQuantity": $number(ProdTable.FIELD_ProdTable_QtySched),
  "plannedProductionStartDateTime": $join([ProdTable.FIELD_ProdTable_SchedStart, "T", ProdTable.FIELD_ProdTable_SchedFromTime, ".000Z"]),
  "plannedProductionEndDateTime": $join([ProdTable.FIELD_ProdTable_SchedEnd, "T", ProdTable.FIELD_ProdTable_SchedToTime, ".000Z"]),
  "partListId": ProdTable.FIELD_ProdTable_gldPartlistId,
  "bomReference": ProdTable.FIELD_ProdTable_GLDCollectRefProdId,
  "bomLevel": ProdTable.FIELD_ProdTable_GLDCollectRefLevel,
  "bomListId": ProdTable.FIELD_ProdTable_BOMId,
  "inputMaterialAvailabilityDate": ProdTable.FIELD_ProdTable_gaxDisplayAvailabilityDate,
  "itemNumber": ProdTable.FIELD_ProdTable_ItemId,
  "itemName": ProdTable.FIELD_ProdTable_Name,
  "itemAbbreviation": ProdTable.InventTable.FIELD_InventTable_GLDItemAbbreviation,
  "partGrossHeight": $number(ProdTable.FIELD_ProdTable_inventTable_grossHeight),
  "partGrossWidth": $number(ProdTable.FIELD_ProdTable_inventTable_grossWidth),
  "partGrossDepth": $number(ProdTable.FIELD_ProdTable_inventTable_grossDepth),
  "partGrossWeight": $number(ProdTable.FIELD_ProdTable_inventTable_grossWeight),
  "partGrossVolume": $number(ProdTable.FIELD_ProdTable_inventTable_grossVolume),
  "resource": ProdTable.ProdRoute.ProdRouteJob[0].FIELD_ProdRouteJob_WrkCtrId,
  "orderNumber": ProdTable.FIELD_ProdTable_GLDICSalesId ? ProdTable.FIELD_ProdTable_GLDICSalesId : null,
  "mesColor": ProdTable.FIELD_ProdTable_GLDColor,
  "mesCoatingType": ProdTable.FIELD_ProdTable_GLDCoatingType,
  "rawMaterialProfile": ProdTable.FIELD_ProdTable_GLDRawMaterialProfileItemId,
  "rawMaterialConfig": ProdTable.FIELD_ProdTable_GLDRawMaterialConfigId,
  "rawMaterialColor": ProdTable.FIELD_ProdTable_GLDRawMaterialColor,
  "rawMaterialStyle": ProdTable.FIELD_ProdTable_GLDRawMaterialStyleId,
  "serialId": ProdTable.FIELD_ProdTable_inventDim_inventSerialId,
  "refProductionId": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_ProdId,
  "referenceOrder": {
    "productionId": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_ProdId,
    "productionStatusDescription": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_ProdStatus1,
    "resourcePoolId": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_GLDResourcePoolId,
    "capabilityDescription": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_GLDWrkCtrCapabilityDescription1,
    "itemId": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_ItemId,
    "itemName": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_Name,
    "productionStatus": $number(ProdTable.ProdTable_GLDCollectRef.RefProdStatus),
    "scheduledDate": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_SchedDate,
    "scheduledTime": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_SchedFromTime,
    "scheduledDateTime": (
      $date := ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_SchedDate;
      $time := ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_SchedFromTime;
      $date and $time ? $join([$date, "T", $time, ".000Z"]) : null
    ),
    "deliveryDate": ProdTable.ProdTable_GLDCollectRef.FIELD_ProdTable_DlvDate
  },
  "successor": {
    "productionId": ProdTable.ProdTable_RefOrder.FIELD_ProdTable_ProdId,
    "productionStatusDescription": ProdTable.ProdTable_RefOrder.FIELD_ProdTable_ProdStatus1,
    "capabilityDescription": ProdTable.ProdTable_RefOrder.FIELD_ProdTable_GLDWrkCtrCapabilityDescription,
    "itemId": ProdTable.ProdTable_RefOrder.FIELD_ProdTable_ItemId,
    "itemName": ProdTable.ProdTable_RefOrder.FIELD_ProdTable_Name,
    "productionStatus": $number(ProdTable.ProdTable_RefOrder.RefProdStatus),
    "scheduledDate": ProdTable.ProdTable_RefOrder.FIELD_ProdTable_SchedDate,
    "scheduledTime": ProdTable.ProdTable_RefOrder.FIELD_ProdTable_SchedFromTime,
    "scheduledDateTime": (
      $date := ProdTable.ProdTable_RefOrder.FIELD_ProdTable_SchedDate;
      $time := ProdTable.ProdTable_RefOrder.FIELD_ProdTable_SchedFromTime;
      $date and $time ? $join([$date, "T", $time, ".000Z"]) : undefined
    )
  },
  "productionRouteOperation": ProdTable.ProdRoute.ProdRouteJob[].{
    "productionRouteJobID": FIELD_ProdRouteJob_JobId,
    "productionRouteOperationNumber": FIELD_ProdRouteJob_OprNum,
    "productionRouteOperationPriority": FIELD_ProdRouteJob_OprPriority,
    "productionRouteOperation": FIELD_ProdRouteJob_prodRoute_OprId,
    "productionRouteOperationJobType": FIELD_ProdRouteJob_JobType,
    "productionRouteOperationName": FIELD_ProdRouteJob_prodRoute_operationName,
    "productionRouteOperationRunTime": $number(FIELD_ProdRouteJob_prodRoute_ProcessTime),
    "productionRouteOperationProcessQuantity": $number(FIELD_ProdRouteJob_prodRoute_ProcessPerQty),
    "productionRouteOperationResource": FIELD_ProdRouteJob_prodRoute_displayWrkCtrId,
    "productionRouteOperationStartDateTime": $join([FIELD_ProdRouteJob_prodRoute_FromDate, "T", FIELD_ProdRouteJob_prodRoute_FromTime, ".000Z"]),
    "productionRouteOperationEndDateTime": $join([FIELD_ProdRouteJob_prodRoute_ToDate, "T", FIELD_ProdRouteJob_prodRoute_ToTime, ".000Z"]),
    "productionRouteOperationTransportTime": $number(FIELD_prodRoute_TransTime),
    "productionRouteOperationComputedEndTime": $fromMillis(
        $toMillis($join([FIELD_ProdRouteJob_prodRoute_ToDate, "T", FIELD_ProdRouteJob_prodRoute_ToTime, ".000Z"]))
        + ($number(FIELD_prodRoute_TransTime) * 60000)
      )
  },
  "bomListLine": ProdTable.ProdBOM[].{
    "partListLinePosition": FIELD_ProdBOM_LineNum,
    "partItemNumber": FIELD_ProdBOM_ItemId,
    "partOperationNumber": FIELD_ProdBOM_OprNum,
    "partProductName": FIELD_ProdBOM_itemName,
    "partQuantity": $number(FIELD_ProdBOM_BOMQty),
    "partQuantityUnit": FIELD_ProdBOM_UnitId,
    "partColor": FIELD_ProdBOM_inventDim_InventColorId,
    "partGrossHeight": $number(FIELD_ProdBOM_inventTable_grossHeight),
    "partGrossWidth": $number(FIELD_ProdBOM_inventTable_grossWidth),
    "partGrossDepth": $number(FIELD_ProdBOM_inventTable_grossDepth),
    "partGrossWeight": $number(FIELD_ProdBOM_inventTable_grossWeight),
    "partCalculatedQuantity": $number(FIELD_ProdBOM_QtyBOMCalc),
    "partRemainingQuantity": $number(FIELD_ProdBOM_RemainBOMPhysical),
    "partSize": $exists(FIELD_ProdBOM_inventDim_InventSizeId) and $not(FIELD_ProdBOM_inventDim_InventSizeId in ["", ".", null]) ? $number(FIELD_ProdBOM_inventDim_InventSizeId) : undefined,
    "partProductNumber": FIELD_ProdBOM_fxlDisplayProductNumber,
    "partConfigId": FIELD_ProdBOM_inventDim_configId,
    "partColorId": FIELD_ProdBOM_inventDim_InventColorId,
    "partSizeId": FIELD_ProdBOM_inventDim_InventSizeId,
    "partStyleId": FIELD_ProdBOM_inventDim_InventStyleId,
    "partBatchNumber": FIELD_ProdBOM_inventDim_inventBatchId,
    "inventTransId": FIELD_ProdBOM_InventTransId
  }
}`;

const transform = jsonata(expression);
let resultsCache = [];

const filterMap = {
  filterProductionId: 'productionId',
  filterProject: 'project',
  filterItemNumber: 'itemNumber',
  filterResource: 'resource'
};

const selectedFilters = {
  productionId: new Set(),
  project: new Set(),
  itemNumber: new Set(),
  resource: new Set()
};

// Wandelt einen JSON-String in HTML mit einfachen Farben um
function syntaxHighlight(json) {
  json = json
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
  return json.replace(/("(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*"(:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g, match => {
    let cls = 'number';
    if (/^"/.test(match)) {
      cls = /:$/.test(match) ? 'key' : 'string';
    } else if (/true|false/.test(match)) {
      cls = 'boolean';
    } else if (/null/.test(match)) {
      cls = 'null';
    }
    return `<span class="${cls}">${match}</span>`;
  });
}

function createOptions(containerId, values) {
  const field = filterMap[containerId];
  const container = document.getElementById(containerId);
  const search = container.querySelector('.filter-search');
  const optionsDiv = container.querySelector('.filter-options');
  optionsDiv.innerHTML = '';
  selectedFilters[field].clear();

  Array.from(values).sort().forEach(v => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.dataset.value = v;
    btn.textContent = v;
    btn.className = 'px-2 py-1 border rounded text-sm bg-white';
    btn.addEventListener('click', () => {
      const set = selectedFilters[field];
      if (set.has(v)) {
        set.delete(v);
        btn.classList.remove('bg-blue-500', 'text-white');
      } else {
        set.add(v);
        btn.classList.add('bg-blue-500', 'text-white');
      }
      applyFilters();
    });
    optionsDiv.appendChild(btn);
  });

  search.value = '';
  search.oninput = () => {
    const val = search.value.toLowerCase();
    selectedFilters[field].clear();
    optionsDiv.querySelectorAll('button').forEach(b => {
      const match = b.dataset.value.toLowerCase().includes(val);
      b.style.display = match ? '' : 'none';
      if (match && val) {
        b.classList.add('bg-blue-500', 'text-white');
        selectedFilters[field].add(b.dataset.value);
      } else {
        b.classList.remove('bg-blue-500', 'text-white');
      }
    });
    applyFilters();
  };
}

function populateFilters() {
  const prod = new Set();
  const proj = new Set();
  const item = new Set();
  const res = new Set();
  resultsCache.forEach(r => {
    if (!r.data) return;
    if (r.data.productionId) prod.add(r.data.productionId);
    if (r.data.project) proj.add(r.data.project);
    if (r.data.itemNumber) item.add(r.data.itemNumber);
    if (r.data.resource) res.add(r.data.resource);
  });

  createOptions('filterProductionId', prod);
  createOptions('filterProject', proj);
  createOptions('filterItemNumber', item);
  createOptions('filterResource', res);
}

function buildTable() {
  const tbody = document.querySelector('#resultsTable tbody');
  tbody.innerHTML = '';
  resultsCache.forEach((entry, idx) => {
    const { formatted, data } = entry;
    const tr = document.createElement('tr');
    tr.className = 'align-top bg-white even:bg-gray-50';
    tr.dataset.productionid = (data?.productionId || '').toString();
    tr.dataset.project = (data?.project || '').toString();
    tr.dataset.itemnumber = (data?.itemNumber || '').toString();
    tr.dataset.resource = (data?.resource || '').toString();
    tr.dataset.json = formatted.toLowerCase();

    const tdIndex = document.createElement('td');
    tdIndex.className = 'border-b border-gray-200 p-3 text-center text-gray-500';
    tdIndex.textContent = idx + 1;

    const tdJson = document.createElement('td');
    tdJson.className = 'border-b border-gray-200 p-3';
    const toggle = document.createElement('button');
    toggle.className = 'mr-2 text-blue-600 font-bold focus:outline-none';
    toggle.textContent = '▶';
    const pre = document.createElement('pre');
    pre.className = 'text-sm text-gray-700 collapsed syntax-highlight';
    pre.innerHTML = syntaxHighlight(formatted);
    toggle.addEventListener('click', () => {
      pre.classList.toggle('collapsed');
      toggle.textContent = pre.classList.contains('collapsed') ? '▶' : '▼';
    });
    tdJson.appendChild(toggle);
    tdJson.appendChild(pre);

    const tdAction = document.createElement('td');
    tdAction.className = 'border-b border-gray-200 p-3 text-center';
    const btn = document.createElement('button');
    btn.className = 'px-3 py-1.5 bg-green-500 text-white text-sm font-semibold rounded-md shadow-sm hover:bg-green-600 transition-colors';
    btn.textContent = 'Kopieren';
    btn.addEventListener('click', () => {
      navigator.clipboard.writeText(formatted);
      btn.textContent = 'Kopiert!';
      btn.classList.replace('bg-green-500', 'bg-indigo-500');
      setTimeout(() => {
        btn.textContent = 'Kopieren';
        btn.classList.replace('bg-indigo-500', 'bg-green-500');
      }, 2000);
    });
    tdAction.appendChild(btn);

    tr.appendChild(tdIndex);
    tr.appendChild(tdJson);
    tr.appendChild(tdAction);
    tbody.appendChild(tr);
  });
}

function applyFilters() {
  const text = document.getElementById('filterFreeText').value.toLowerCase();
  const prod = selectedFilters.productionId;
  const proj = selectedFilters.project;
  const item = selectedFilters.itemNumber;
  const res = selectedFilters.resource;

  document.querySelectorAll('#resultsTable tbody tr').forEach(tr => {
    const matchesProd = prod.size === 0 || prod.has(tr.dataset.productionid);
    const matchesProj = proj.size === 0 || proj.has(tr.dataset.project);
    const matchesItem = item.size === 0 || item.has(tr.dataset.itemnumber);
    const matchesRes = res.size === 0 || res.has(tr.dataset.resource);
    const matchesText = !text || tr.dataset.json.includes(text);
    tr.style.display = (matchesProd && matchesProj && matchesItem && matchesRes && matchesText) ? '' : 'none';
  });
}

function processCsv(text) {
  const rawLines = text.trim().split(/\r?\n/);
  const logicalLines = [];
  let currentLogicalLine = "";

  for (const rawLine of rawLines) {
    const isNewRecord = rawLine.startsWith('"timestamp"') || /^\d{4}-\d{2}-\d{2}/.test(rawLine.trim());

    if (isNewRecord && currentLogicalLine !== "") {
      logicalLines.push(currentLogicalLine);
      currentLogicalLine = rawLine;
    } else {
      currentLogicalLine += (currentLogicalLine ? "\n" : "") + rawLine;
    }
  }
  if (currentLogicalLine !== "") {
    logicalLines.push(currentLogicalLine);
  }

  if (logicalLines.length > 0 && logicalLines[0].startsWith('"timestamp"')) {
    logicalLines.shift();
  }

  resultsCache = [];

  logicalLines.forEach((line) => {
    const commaIndex = line.indexOf(',');
    if (commaIndex === -1) return;

    let jsonPart = line.substring(commaIndex + 1).trim();

    if (jsonPart.startsWith('"') && jsonPart.endsWith('"')) {
      jsonPart = jsonPart.slice(1, -1);
    }

    jsonPart = jsonPart.replace(/""/g, '"');

    let formatted;
    let data;
    try {
      const message = JSON.parse(jsonPart);
      data = transform.evaluate(message);
      formatted = JSON.stringify(data, null, 2);
    } catch (e) {
      formatted = `Fehler beim Verarbeiten von Zeile ${resultsCache.length + 1}:\n${e.message}\n\n--- Problemhafter JSON-Teil (nach Bereinigung) ---\n${jsonPart}`;
      data = null;
    }

    resultsCache.push({ formatted, data });
  });

  populateFilters();
  buildTable();
  applyFilters();
}

document.getElementById('transformButton').addEventListener('click', () => {
  const inputText = document.getElementById('csvInput').value;
  processCsv(inputText);
});

document.getElementById('csvFile').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const text = ev.target.result;
    document.getElementById('csvInput').value = text;
    processCsv(text);
  };
  reader.readAsText(file);
});

document.getElementById('filterFreeText').addEventListener('input', applyFilters);
</script>
</body>
</html>
